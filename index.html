<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Story Tag — Two-Player Word Game</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    :root { --footer-h: 34px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    @media (max-width: 768px){ :root{ --footer-h: 40px; } }

    body { margin:0; background:#0f1220; color:#f5f7ff; display:flex; min-height:100vh; }
    .wrap { margin:auto; width:min(900px, 92vw); padding:24px; padding-bottom: calc(var(--footer-h) + env(safe-area-inset-bottom, 0px) + 12px); }
    .card { background:#171a2b; border:1px solid #2a2f4a; border-radius:16px; padding:18px 18px 16px; gap:16px; display:flex; flex-direction:column; box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:hidden; }

    .muted { color:#b9c0ff; opacity:.9; }
    .strong { font-weight:600; color:#fff; }
    .title { font-weight:800; font-size:clamp(24px, 3.4vw, 36px); letter-spacing:.3px; display:flex; align-items:center; gap:10px; }
    .title .logo { width:28px; height:28px; border-radius:6px; background:linear-gradient(135deg, #7b88ff, #58a6ff); box-shadow:0 6px 18px rgba(88,166,255,.4); }
    .subtle { color:#9aa3d7; }

    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid #2a2f4a; background:#0f1328; border-radius:999px; }
    .pill .dot { width:10px; height:10px; border-radius:50%; border:1px solid #2a2f4a; background:#58a6ff; }
    .pill .presence { font-size:.85em; padding:2px 6px; border-radius:999px; border:1px solid #2a2f4a; background:#101534; }
    .presence.online { color:#7af5b0; border-color:#2e5a4a; background:#0f1f1a; }
    .presence.away { color:#ffd37a; border-color:#5a4f2e; background:#1f1a0f; }
    .presence.offline { color:#b9c0ff; }

    .divider { height:1px; width:100%; background:linear-gradient(90deg, transparent, #2a2f4a, transparent); margin:6px 0; }

    .story { font-size: clamp(18px, 2.6vw, 22px); line-height:1.7; letter-spacing:.2px; min-height:120px; padding:6px 4px; border-radius:10px; background:#0f1328; border:1px solid #303659; }
    .word { display:inline; } .word + .word::before { content:" "; }

    .colourWrap { position:relative; display:inline-block; }
    .swatch{ width:28px; height:14px; border-radius:7px; border:1px solid #2a2f4a; background:#58a6ff; display:inline-block; vertical-align:middle; }
    .swatchInput{ position:absolute; inset:0; opacity:0; cursor:pointer; }

    .spacer { height:6px; }
    .row.space { gap:8px; }
    .turn { color:#fff; font-weight:700; }
    .nameTag { color:#e6ebff; font-weight:700; }
    .subtleKey { color:#92a0ff; font-variant-numeric: tabular-nums; }

    .footer { position:fixed; left:0; right:0; bottom:0; padding:6px 10px calc(env(safe-area-inset-bottom, 0px) + 6px); display:flex; align-items:center; gap:12px; justify-content:center; background:linear-gradient(180deg, rgba(15,18,32,0), rgba(15,18,32,.9)); backdrop-filter: blur(4px); }
    .footer-chip { font-size:.8em; color:#9aa3d7; padding:6px 10px; background:#101534; border:1px solid #2a2f4a; border-radius:999px; white-space:nowrap; }

    header { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .build { display:flex; align-items:center; gap:10px; }
    .badge { font-size:.7em; font-weight:700; letter-spacing:.3px; color:#9aa3d7; display:inline-flex; align-items:center; gap:8px; }
    .badge .spark { width:8px; height:8px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #7b88ff, #58a6ff); box-shadow:0 0 16px #58a6ff; }

    .players { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .players .pill { gap:8px; }
    .players .name { color:#fff; font-weight:700; }
    .players .small { font-size:.9em; color:#9aa3d7; }

    .controls { display:flex; gap:8px; flex-wrap:wrap; }
    input[type="text"], input[type="password"]{
      width:100%; max-width:100%; padding:12px 14px; border-radius:10px; border:1px solid #303659;
      background:#0f1328; color:#fff; font-size:16px; display:block;
    }
    input::placeholder { color:#8890b3; } input[disabled]{ opacity:.6; }
    button { padding:12px 16px; border-radius:10px; border:1px solid #2a2f4a; background:#28315e; color:#fff; cursor:pointer; transition:.15s transform ease; }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }

    .btnSecondary { background:#1a2040; }
    .btnDanger { background:#4a2030; border-color:#5a2a3a; }
    .btnQuiet { background:#111735; border-color:#2a2f4a; }

    .error { color:#ff8a9a; }

    .help { font-size:.85em; color:#9aa3d7; }
    .kbd { display:inline-flex; align-items:center; justify-content:center; padding:1px 6px; border-radius:6px; border:1px solid #2a2f4a; background:#111735; font-weight:700; font-size:.85em; color:#c6cdff; }

    .tag { font-size: .62em; font-weight: 500; color:#9aa3d7; letter-spacing:.4px;
      background:#12162c; border:1px solid #2a2f4a; padding:4px 8px; border-radius:999px;
    }
    .version-badge { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color:#b9c0ff; }

    p.sub { margin:0 0 18px; color:#b9c0ff; }
    .grid { display:grid; gap:12px; grid-template-columns: 1fr; }
    label { font-size:14px; color:#b9c0ff; }
    input[type="text"], input[type="password"]{
      width:100%; max-width:100%; padding:12px 14px; border-radius:10px; border:1px solid #303659;
      background:#0f1328; color:#fff; font-size:16px; display:block;
    }
    input::placeholder { color:#8890b3; } input[disabled]{ opacity:.6; }
    button { padding:12px 16px; border-radius:10px; border:1px solid #2a2f4a; background:#28315e; color:#fff; cursor:pointer; transition:.15s transform ease; }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }

    .row.center { align-items:center; }
    .tip { color:#9aa3d7; font-size:.9em; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title"><span class="logo"></span>Story Tag</div>
      <div class="build">
        <div class="badge"><span class="spark"></span><span>Build</span></div>
        <div id="buildVersion" class="version-badge">v0.0.0</div>
      </div>
    </header>

    <div class="spacer"></div>

    <div id="auth" class="card" role="region" aria-label="Session">
      <p class="sub">Start a new session or join an existing one.</p>
      <div class="grid">
        <label>Your Name
          <input id="name" type="text" placeholder="e.g., Alex" />
        </label>
        <div class="row">
          <button id="createBtn">Create Session</button>
          <button id="joinBtn" class="btnSecondary">Join Session</button>
          <span id="joinStatus" class="help"></span>
        </div>
        <label id="sessionLabel">Session ID
          <input id="sessionId" type="text" placeholder="e.g., ABC123" />
        </label>
        <label>Password
          <input id="password" type="password" placeholder="Optional, but recommended" />
        </label>
        <label><input id="rememberChk" type="checkbox" /> Remember this device for this session</label>
        <div class="help" id="savedHint"></div>
      </div>
    </div>

    <div id="game" class="card" role="region" aria-label="Game" hidden>
      <div class="row players">
        <div class="pill"><span id="youDot" class="dot"></span><span id="youLabel" class="name">You</span><span id="youPresence" class="presence offline">(offline)</span></div>
        <div class="pill"><span id="peerDot" class="dot"></span><span id="peerLabel" class="name">Partner</span><span id="peerPresence" class="presence offline">(offline)</span></div>
      </div>

      <div class="row">
        <div class="pill">Words: <span id="wordCount">0</span></div>
        <div class="pill">Status: <span id="statusDot">Waiting…</span></div>
        <div class="pill">
          Colour:
          <span class="colourWrap">
            <span id="colourSwatch" class="swatch" title="Pick your colour"></span>
            <input id="colourPicker" type="color" class="swatchInput" value="#58a6ff" />
          </span>
        </div>
      </div>

      <div class="divider"></div>

      <div class="story" id="storyBox" aria-live="polite">(No words yet—be the first to write!)</div>
      <div class="spacer"></div>

      <div id="turnBanner" class="muted">Waiting for partner…</div>
      <div class="spacer"></div>

      <div class="row space">
        <input id="wordInput" type="text" placeholder="Type a single word…" />
        <button id="submitBtn" disabled>Submit</button>
        <button id="copyBtn" class="btnQuiet">Copy Text</button>
        <button id="downloadBtn" class="btnQuiet">Download</button>
        <button id="leaveBtn" class="btnDanger">Leave</button>
      </div>

      <div id="errorBox" class="error"></div>
    </div>
  </div>

  <div class="footer">
    <div class="footer-chip">Built for fun — share your Session ID + Password with a friend and take turns!</div>
  </div>

  <!-- App -->
  <script type="module">
    /* ========= Version badge from version.json ========= */
    const VERSION_FALLBACK = "v0.0.0";
    (async () => {
      try {
        const res = await fetch(`version.json?ts=${Date.now()}`, { cache: "no-store" });
        const data = await res.json();
        const v = (data && data.version ? data.version : VERSION_FALLBACK);
        document.getElementById("buildVersion").textContent = `v${String(v).replace(/^v/i, "")}`;
      } catch {
        document.getElementById("buildVersion").textContent = VERSION_FALLBACK;
      }
    })();

    /* ========= Firebase ========= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getDatabase, ref, get, set, update, onValue, serverTimestamp,
      onDisconnect, remove
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCVOzSTr3lPRm1BRzKTJtdEG-nsdnVIhiM",
      authDomain: "zetabun-91b0c.firebaseapp.com",
      databaseURL: "https://zetabun-91b0c-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "zetabun-91b0c",
      storageBucket: "zetabun-91b0c.firebasestorage.app",
      messagingSenderId: "594713569270",
      appId: "1:594713569270:web:fa1d230bd5fd1ce28549d7",
      measurementId: "G-SQR25FYPLC"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ========= DOM ========= */
    const $ = id => document.getElementById(id);
    const createBtn = $("createBtn"), joinBtn = $("joinBtn"), joinStatus = $("joinStatus"),
          auth = $("auth"), game = $("game"),
          nameInput = $("name"), sessionInput = $("sessionId"), passwordInput = $("password"),
          rememberChk = $("rememberChk"), savedHint = $("savedHint"),
          sessionLabel = $("sessionLabel"),
          youLabel = $("youLabel"), peerLabel = $("peerLabel"),
          youDot = $("youDot"), peerDot = $("peerDot"),
          youPresence = $("youPresence"), peerPresence = $("peerPresence"),
          wordCount = $("wordCount"), statusDot = $("statusDot"),
          storyBox = $("storyBox"), turnBanner = $("turnBanner"),
          wordInput = $("wordInput"), submitBtn = $("submitBtn"),
          colourPicker = $("colourPicker"), colourSwatch = $("colourSwatch"),
          copyBtn = $("copyBtn"), downloadBtn = $("downloadBtn"), leaveBtn = $("leaveBtn"),
          errorBox = $("errorBox");

    /* ========= Stable client id ========= */
    const CID_KEY = "storytag_client_id";
    function getClientId(){ let cid=localStorage.getItem(CID_KEY)||""; if(!cid){ const bytes=crypto.getRandomValues(new Uint8Array(16)); let bin=""; for(let b of bytes) bin+=String.fromCharCode(b);
      return btoa(bin).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"");
    } localStorage.setItem(CID_KEY,cid); return cid; }
    const clientId = getClientId();

    /* ========= Local storage ========= */
    const LS_KEY="storytag_state_v1", REM_KEY="storytag_remembered_sessions_v1", LAST_KEY="storytag_last_session_v1";
    const saveLocal=s=>localStorage.setItem(LS_KEY,JSON.stringify(s));
    const loadLocal=()=>{ try{return JSON.parse(localStorage.getItem(LS_KEY)||"{}");}catch{return{};} };
    const loadRememberMap=()=>{ try{return JSON.parse(localStorage.getItem(REM_KEY)||"{}");}catch{return{};} };
    const saveRememberMap=m=>localStorage.setItem(REM_KEY,JSON.stringify(m));
    const saveLastSession=o=>localStorage.setItem(LAST_KEY,JSON.stringify(o||{}));
    const loadLastSession=()=>{ try{return JSON.parse(localStorage.getItem(LAST_KEY)||"null");}catch{return null;} };

    /* ========= Presence ========= */
    const ONLINE_MS = 20*1000, AWAY_MS = 2*60*1000, STALE_MS = 60*1000;

    function setSavedHintText(sid){ const map=loadRememberMap(); savedHint.textContent=(sid&&map[sid])?"Saved on this device — password optional.":""; }

    /* ========= Helpers ========= */
    const WORD_RX=/^[A-Za-z]+(?:['-][A-Za-z]+)*(?:[.,!?])?$/;
    const titleCaseFirstWordIfNeeded=(i,w)=>(i===0&&w.length)?w[0].toUpperCase()+w.slice(1):w;
    const escapeHtml = s => String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    const presenceOf = (ts)=>{ const now=Date.now(); if(!ts) return {cls:"offline",label:"(offline)"}; const age=now-ts; if(age<ONLINE_MS) return {cls:"online",label:"online"}; if(age<AWAY_MS) return {cls:"away",label:"away"}; return {cls:"offline",label:"(offline)"}; };
    function setDotColour(el, hex, hasPlayer){ el.style.background = hasPlayer ? (hex||"#58a6ff") : "transparent"; el.style.borderColor = hasPlayer ? "#2a2f4a" : "#2a2f4a"; }
    function setMyColourUI(hex){ colourSwatch.style.background=hex||"#58a6ff"; }

    /* ========= Colour persistence ========= */
    const localColour={}; // uid -> hex

    function renderStory(words, players){
      storyBox.innerHTML=""; if(!words.length){ storyBox.textContent="(No words yet—be the first to write!)"; wordCount.textContent="0"; return; }
      for(const w of words){
        const el=document.createElement("span"); el.className="word";
        const col=w.c || (players?.[w.by]?.colour) || localColour[w.by] || "#c6cdff";
        el.style.color=col; el.textContent=w.w; storyBox.appendChild(el);
      }
      wordCount.textContent=String(words.length);
    }

    function setTurnBanner(currentTurnUid, players, myUid){
      if(!players||!players[myUid]){ turnBanner.textContent="Waiting…"; return; }
      const mine=currentTurnUid===myUid;
      const theirUid=Object.keys(players).find(k=>k!==myUid); const their=theirUid?players[theirUid]:null;
      if(mine) turnBanner.innerHTML=`It’s <span class="turn">your</span> turn to write`;
      else if(their) turnBanner.innerHTML=`<span class="nameTag">${escapeHtml(their?.name||"Partner")}</span>’s turn to write`;
      else turnBanner.textContent="Waiting for partner…";
      submitBtn.disabled=!mine; wordInput.disabled=!mine; if(mine) wordInput.focus();
    }

    // Turn sound
    let audioCtx=null, canPlaySound=false, wasMyTurn=null;
    const ensureAudio=()=>{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); };
    function playTurnSound(){
      if(!canPlaySound) return;
      try{ ensureAudio(); const now=audioCtx.currentTime;
        const g=audioCtx.createGain(); g.gain.setValueAtTime(0.001,now); g.gain.exponentialRampToValueAtTime(0.07,now+0.02); g.gain.exponentialRampToValueAtTime(0.0001,now+0.35); g.connect(audioCtx.destination);
        const o=audioCtx.createOscillator(); o.type="sine"; o.frequency.setValueAtTime(660,now); o.frequency.linearRampToValueAtTime(880,now+0.2); o.connect(g); o.start(now); o.stop(now+0.35);
      }catch{}
    }

    function setUIConnected(connected){
      statusDot.textContent = connected ? "Connected" : "Waiting…";
      statusDot.style.color = connected ? "#7af5b0" : "#b9c0ff";
    }

    /* ========= Session flow ========= */
    async function enterSession(kind, opts={}){
      const isCreate = kind==='create';
      const myName = (opts.nameOverride ?? nameInput.value ?? "").trim() || "You";
      const rawSessionId = (opts.sessionIdOverride ?? sessionInput.value ?? "").trim();
      const sessionId = rawSessionId.replace(/\s+/g,"").toUpperCase();
      const password = opts.passwordOverride ?? passwordInput.value ?? "";
      const remember = !!(opts.rememberOverride ?? rememberChk.checked);
      const last = loadLastSession();

      if(!isCreate && !sessionId){ joinStatus.innerHTML='<span class="err">Enter a Session ID</span>'; return; }
      createBtn.disabled=true; joinBtn.disabled=true; joinStatus.textContent="Connecting…";

      try{
        // Derive key
        const enc = new TextEncoder();
        const data = enc.encode(`${sessionId}:${password||""}`);
        const hash = await crypto.subtle.digest("SHA-256", data);
        const hex = Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
        const derivedKey = hex.slice(0,24);

        const sesRef = ref(db, `sessions/${derivedKey}`);
        const snap = await get(sesRef);
        const exists = snap.exists();
        let myUid = last?.myUid || null;

        if(isCreate){
          if(exists){ joinStatus.innerHTML='<span class="err">That Session already exists. Pick another ID or join it.</span>'; return; }
          const newUid = crypto.randomUUID().replace(/-/g,"").slice(0,10);
          myUid = newUid;
          await set(sesRef,{
            createdAt: serverTimestamp(),
            currentTurnUid: newUid,
            players: {
              [newUid]: { name: myName, clientId, colour: localColour[newUid] || colourPicker.value || "#58a6ff", lastActive: Date.now() }
            },
            words: []
          });
        }else{
          // Join flow
          if(!exists){ joinStatus.innerHTML='<span class="err">Session not found.</span>'; return; }
          const val = snap.val() || {};
          const players = val.players || {};
          const foundUid = Object.keys(players).find(u => players[u]?.clientId === clientId);
          myUid = foundUid || crypto.randomUUID().replace(/-/g,"").slice(0,10);

          await update(sesRef, {
            players: {
              ...players,
              [myUid]: {
                ...(players[myUid]||{}),
                name: myName,
                clientId,
                colour: (players[myUid]?.colour) || localColour[myUid] || colourPicker.value || "#58a6ff",
                lastActive: Date.now()
              }
            }
          });
        }

        // Save remember state
        if(remember){ const map=loadRememberMap(); map[sessionId]=true; saveRememberMap(map); }
        saveLastSession({ sessionId, derivedKey, myUid, myName });

        // Swap UI
        auth.hidden=true; game.hidden=false; youLabel.textContent=myName; sessionLabel.innerHTML=`Session ID <span class="tag">${sessionId}</span>`;
        setSavedHintText(sessionId);
        wordInput.value=""; errorBox.textContent=""; canPlaySound=true;

        // Live subscription to session
        if(window._unsub) window._unsub();
        window._unsub=onValue(sesRef,s=>{
          const val=s.val()||{}; const players=val.players||{}; const words=val.words||[]; let cturn=val.currentTurnUid;
          const ids=Object.keys(players); const peerId=ids.find(k=>k!==myUid);

          const meP=presenceOf(players[myUid]?.lastActive); const peP=presenceOf(players[peerId]?.lastActive);
          youPresence.className=`presence ${meP.cls}`; youPresence.textContent=meP.label;
          peerPresence.className=`presence ${peP.cls}`; peerPresence.textContent=peP.label;

          // Merge local colour to avoid flicker (prefer server colour)
          const mergedPlayers=JSON.parse(JSON.stringify(players||{}));
          const serverColour = players?.[myUid]?.colour || null;
          if (serverColour) {
            // Keep server as source of truth and sync local cache
            localColour[myUid] = serverColour;
          } else if (localColour[myUid]) {
            // Only use local cache if server has nothing yet
            mergedPlayers[myUid] = mergedPlayers[myUid] || {};
            mergedPlayers[myUid].colour = localColour[myUid];
          }
          peerLabel.textContent=peerId?(players[peerId]?.name||"Partner"):"(none)";

          // Sync picker & dots using effective colour
          const myEffectiveColour = (players?.[myUid]?.colour) || localColour[myUid] || colourPicker.value || "#c6cdff";
          if (myEffectiveColour && colourPicker.value.toLowerCase() !== myEffectiveColour.toLowerCase()) {
            colourPicker.value = myEffectiveColour;
          }
          setMyColourUI(myEffectiveColour);
          setDotColour(youDot, myEffectiveColour, !!mergedPlayers[myUid]);
          setDotColour(peerDot, mergedPlayers[peerId]?.colour, !!mergedPlayers[peerId]);

          setUIConnected(ids.length>0);
          renderStory(words,mergedPlayers);

          if(cturn && !players[cturn] && ids.length>0){ const nextIds=ids.filter(id=>players[id]); const newTurn=nextIds[0]; update(sesRef,{currentTurnUid:newTurn}); cturn=newTurn; }
          if(ids.length<2 && words.length>0){ submitBtn.disabled=true; wordInput.disabled=true; turnBanner.textContent="Waiting for partner…"; }
          else setTurnBanner(cturn,players,myUid);

          const last=words[words.length-1]; const isMyTurn=(cturn===myUid)&&(ids.length===2);
          if(ids.length===2 && last && last.by===myUid && cturn===myUid && peerId){ update(sesRef,{currentTurnUid:peerId}); }
          if(wasMyTurn===false && isMyTurn) playTurnSound(); wasMyTurn=isMyTurn;

          saveLocal({sessionId:sessionId,myName});
        });

        if(!opts.auto){ wordInput.focus(); joinStatus.innerHTML='<span class="ok">Ready!</span>'; }

        // Presence heartbeat + on interaction
        if(window._presenceTimer) clearInterval(window._presenceTimer);
        window._presenceTimer=setInterval(()=>{ update(ref(db,`sessions/${derivedKey}/players/${myUid}`), { lastActive: Date.now() }).catch(()=>{}); },10000);
        const bump=()=>update(ref(db,`sessions/${derivedKey}/players/${myUid}`),{ lastActive: Date.now() }).catch(()=>{});
        ["click","keydown","touchstart","visibilitychange"].forEach(ev=>document.addEventListener(ev,bump,{passive:true}));

      }catch(e){
        console.error(e);
        if(!opts.auto) joinStatus.innerHTML='<span class="err">Failed. Check console & Firebase config.</span>';
      }finally{
        if(!opts.auto){ joinBtn.disabled=false; createBtn.disabled=false; }
      }
    }

    createBtn.onclick=()=>enterSession('create');
    joinBtn.onclick=()=>enterSession('join');

    /* ========= Clipboard & Download ========= */
    copyBtn.onclick=async ()=>{
      try{
        const text=[...storyBox.querySelectorAll(".word")].map(w=>w.textContent).join(" ").trim();
        await navigator.clipboard.writeText(text);
        copyBtn.textContent="Copied!"; setTimeout(()=>copyBtn.textContent="Copy Text",900);
      }catch{ copyBtn.textContent="Copy failed"; setTimeout(()=>copyBtn.textContent="Copy Text",1200); }
    };

    downloadBtn.onclick=()=>{
      const text=[...storyBox.querySelectorAll(".word")].map(w=>w.textContent).join(" ").trim()+"\n";
      const blob=new Blob([text],{type:"text/plain"}); const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="story.txt"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };

    leaveBtn.onclick=()=>{
      const last=loadLastSession(); if(!last) return location.reload();
      saveLastSession(null); location.reload();
    };

    /* ========= Colour picker handlers ========= */
    async function handleColourChange(){
      try{
        const last=loadLastSession(); if(!last) return;
        const sesRef=ref(db,`sessions/${last.derivedKey}`); const snap=await get(sesRef);
        const players=(snap.val()&&snap.val().players)||{}; const myUid=Object.keys(players).find(u=>players[u]?.clientId===clientId);
        const hex=colourPicker.value;

        // Instant UI
        localColour[myUid]=hex; setMyColourUI(hex); setDotColour(youDot,hex,true);

        // Persist
        if(myUid) await update(ref(db,`sessions/${last.derivedKey}/players/${myUid}`),{ colour:hex, lastActive:Date.now() });
      }catch(e){ console.error(e); }
    }
    colourPicker.addEventListener("input",handleColourChange);
    colourPicker.addEventListener("change",handleColourChange);

    /* ========= Submit word ========= */
    submitBtn.onclick=async ()=>{
      errorBox.textContent="";
      const w = wordInput.value.trim();
      if(!WORD_RX.test(w)){ errorBox.textContent="Enter a single word (letters, optional - or ’, and punctuation like . , ! ?)"; return; }

      try{
        const last=loadLastSession(); if(!last) return;
        const sesRef=ref(db,`sessions/${last.derivedKey}`); const snap=await get(sesRef); const val=snap.val()||{};
        const players=val.players||{}; const words=val.words||[]; const myUid=Object.keys(players).find(u=>players[u]?.clientId===clientId);
        const peerUid=Object.keys(players).find(k=>k!==myUid);
        const myColourNow=(players[myUid]?.colour)||localColour[myUid]||colourPicker.value||"#c6cdff";

        await update(sesRef,{
          words:[...words,{ w:titleCaseFirstWordIfNeeded(words.length,w), by:myUid, c:myColourNow, t:Date.now() }],
          currentTurnUid: peerUid || myUid
        });

        wordInput.value=""; wordInput.focus();
      }catch(e){ console.error(e); errorBox.textContent="Submit failed — try again."; }
    };

    // Enter key to submit
    wordInput.addEventListener("keydown",e=>{ if(e.key==="Enter") submitBtn.click(); });

    /* ========= Auto-rejoin last session ========= */
    (async ()=>{
      const last=loadLastSession();
      if(!last) return;
      nameInput.value=last.myName||"";
      sessionInput.value=last.sessionId||"";
      setSavedHintText(last.sessionId||"");
      await enterSession('join',{ auto:true, sessionIdOverride:last.sessionId||"", nameOverride:last.myName||"", derivedKeyOverride:last.derivedKey||null });
    })();
  </script>

  <!-- Reduce accidental zooms -->
  <script>
    document.documentElement.style.touchAction = 'manipulation';
    ['gesturestart','gesturechange','gestureend'].forEach(evt=>{
      window.addEventListener(evt, e=>{ e.preventDefault(); }, { passive:false });
    });
  </script>
</body>
</html>
